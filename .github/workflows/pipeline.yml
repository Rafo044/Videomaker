name: Smart Video Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'requests/**'
      - 'remotion/**'
      - 'modal_app.py'
      - 'package.json'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'M…ôcburi Deploy?'
        type: boolean
        default: false
      upload_gdrive:
        description: 'Gdrive-a y√ºkl…ônsin?'
        type: boolean
        default: true

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: json
          filters: |
            code:
              - 'modal_app.py'
              - 'remotion/**'
              - 'package.json'
            requests:
              - 'requests/*.json'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Validate JSON Requests
        run: npx tsx scripts/validate_json.ts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Deploy to Modal
        if: steps.filter.outputs.code == 'true' || github.event.inputs.force_deploy == 'true'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          modal deploy modal_app.py

      - name: Render Video
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          CHANGED_FILES: ${{ steps.filter.outputs.requests_files }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          python -c '
          import modal, json, os, glob
          from pathlib import Path
          
          try:
              f = modal.Function.from_name("remotion-video-service", "render_video")
          except Exception as e:
              print(f"Error connecting: {e}")
              exit(1)

          try:
              json_files = json.loads(os.getenv("CHANGED_FILES", "[]"))
          except:
              json_files = []

          if not json_files and os.getenv("EVENT_NAME") == "workflow_dispatch":
              json_files = sorted(glob.glob("requests/*.json"), key=os.path.getmtime)[-1:]

          if not json_files:
              print("No changed requests to process.")
              exit(0)

          os.makedirs("renders", exist_ok=True)
          for json_file in json_files:
              if not os.path.exists(json_file): continue
              stem = Path(json_file).stem
              print(f"\nüöÄ PROCESSING: {json_file}")
              try:
                  with open(json_file, "r") as j:
                      data = json.load(j)
                  
                  results = f.remote(data, upload_gdrive=False)
                  
                  if isinstance(results, dict):
                      for filename, content in results.items():
                          if isinstance(content, bytes):
                              save_path = f"renders/{stem}_{filename}"
                              with open(save_path, "wb") as out:
                                  out.write(content)
                              print(f"‚úÖ Saved: {save_path}")
                          else:
                              print(f"üîó Cloud Path: {content}")
              except Exception as e:
                  print(f"‚ùå Error rendering {json_file}: {e}")
          '

      - name: Install GDrive Dependencies
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        run: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Upload to Google Drive
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          for video in renders/*.mp4; do
            if [ -f "$video" ]; then
              python scripts/upload_gdrive.py "$video"
            fi
          done

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-videos-${{ github.run_id }}
          path: renders/*.mp4
          if-no-files-found: warn
