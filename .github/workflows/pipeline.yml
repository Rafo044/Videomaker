name: Smart Video Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'requests/**'
      - 'remotion/**'
      - 'modal_app.py'
      - 'package.json'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'M…ôcburi Deploy?'
        type: boolean
        default: false
      upload_gdrive:
        description: 'Gdrive-a y√ºkl…ônsin?'
        type: boolean
        default: true

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'modal_app.py'
              - 'remotion/**'
              - 'package.json'
            requests:
              - 'requests/*.json'

      # ---------------------------------------------------------
      # STEP 1: VALIDATION & SETUP
      # ---------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Validate JSON Requests
        # H…ômi≈ü…ô yoxlayaq ki, s…ôhv JSON-la render ba≈ülamasƒ±n
        run: npx tsx scripts/validate_json.ts

      # ---------------------------------------------------------
      # STEP 2: MODAL ACTIONS
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Deploy to Modal
        # YALNIZ kod d…ôyi≈üibs…ô deploy edirik (M…ôsr…ôf v…ô vaxta q…ôna…ôt)
        if: steps.filter.outputs.code == 'true' || github.event.inputs.force_deploy == 'true'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          modal deploy modal_app.py

      - name: Render Sequential JSON Requests
        # YALNIZ JSON d…ôyi≈üibs…ô v…ô ya …ôll…ô ba≈üladƒ±lƒ±bsa render edirik
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          GDRIVE_UPLOAD: ${{ github.event.inputs.upload_gdrive || 'true' }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          python -c '
          import modal, json, os, glob
          from pathlib import Path
          
          try:
              f = modal.Function.from_name("remotion-video-service", "render_video")
          except Exception as e:
              print(f"X…ôta: Servis tapƒ±lmadƒ±! {e}")
              exit(1)

          print(f"D…ôyi≈ümi≈ü JSON fayllarƒ± t…ôsbit edilir...")
          
          # Yalnƒ±z son commit-d…ô d…ôyi≈ümi≈ü JSON-larƒ± tapmaq (v…ô ya hamƒ±sƒ±nƒ± yox, sonuncunu)
          import subprocess
          try:
              diff_cmd = ["git", "diff", "--name-only", "HEAD^", "HEAD", "requests/"]
              changed_files = subprocess.check_output(diff_cmd).decode("utf-8").splitlines()
              json_files = [f for f in changed_files if f.endswith(".json") and os.path.exists(f)]
          except:
              # ∆èg…ôr diff alƒ±nmasa (m…ôs…ôl…ôn ilk commit), …ôn son yaradƒ±lan faylƒ± g√∂t√ºr…ôk
              json_files = sorted(glob.glob("requests/*.json"), key=os.path.getmtime)[-1:]

          if not json_files:
              print("Render √º√ß√ºn yeni v…ô ya d…ôyi≈ümi≈ü JSON faylƒ± tapƒ±lmadƒ±.")
              exit(0)

          os.makedirs("renders", exist_ok=True)
          
          print(f"Toplam {len(json_files)} yeni fayl emal olunacaq: {json_files}")

          for json_file in json_files:
              stem = Path(json_file).stem
              print(f"\nüöÄ PROSES BA≈ûLADI: {json_file}")
              try:
                  with open(json_file, "r") as j:
                      data = json.load(j)
                                   results = f.remote(data, upload_gdrive=False)
                  
                  if isinstance(results, dict):
                      # Handle Hybrid Format:
                      files_to_save = results if "files" not in results else results.get("files", {})
                      
                      for filename, content in results.items():
                          if isinstance(content, bytes):
                              save_path = f"renders/{stem}_{filename}"
                              with open(save_path, "wb") as out:
                                  out.write(content)
                              print(f"üíæ Artifact √º√ß√ºn fayl yaradƒ±ldƒ±: {save_path}")
                          elif isinstance(content, str):
                              print(f"üîó Cloud-da saxlanƒ±ldƒ±: {content}")
                  else:
                      print(f"‚ö†Ô∏è G√∂zl…ônilm…ôy…ôn n…ôtic…ô tipi: {type(results)}")

              except Exception as e:
                  print(f"!!! KRƒ∞Tƒ∞K X∆èTA ({json_file}): {str(e)}")
                  continue
          '

      - name: Install GDrive Dependencies
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        run: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Upload to Google Drive
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          for video in renders/*.mp4; do
            if [ -f "$video" ]; then
              python scripts/upload_gdrive.py "$video"
            fi
          done

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-videos-${{ github.run_id }}
          path: renders/*.mp4
          if-no-files-found: warn
