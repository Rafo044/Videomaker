name: Smart Video Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'requests/**'
      - 'remotion/**'
      - 'modal_app.py'
      - 'package.json'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Məcburi Deploy?'
        type: boolean
        default: false
      upload_gdrive:
        description: 'Gdrive-a yüklənsin?'
        type: boolean
        default: true

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'modal_app.py'
              - 'remotion/**'
              - 'package.json'
            requests:
              - 'requests/*.json'

      # ---------------------------------------------------------
      # STEP 1: VALIDATION & SETUP
      # ---------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Validate JSON Requests
        # Həmişə yoxlayaq ki, səhv JSON-la render başlamasın
        run: npx tsx scripts/validate_json.ts

      # ---------------------------------------------------------
      # STEP 2: MODAL ACTIONS
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Deploy to Modal
        # YALNIZ kod dəyişibsə deploy edirik (Məsrəf və vaxta qənaət)
        if: steps.filter.outputs.code == 'true' || github.event.inputs.force_deploy == 'true'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          modal deploy modal_app.py

      - name: Render Sequential JSON Requests
        # YALNIZ JSON dəyişibsə və ya əllə başladılıbsa render edirik
        if: steps.filter.outputs.requests == 'true' || github.event_name == 'workflow_dispatch'
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          GDRIVE_UPLOAD: ${{ github.event.inputs.upload_gdrive || 'true' }}
        run: |
          modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET
          python -c '
          import modal, json, os, glob
          from pathlib import Path
          
          try:
              f = modal.Function.from_name("remotion-video-service", "render_video")
          except Exception as e:
              print(f"Xəta: Servis tapılmadı! {e}")
              exit(1)

          json_files = glob.glob("requests/*.json")
          if not json_files:
              print("Render üçün heç bir JSON faylı tapılmadı.")
              exit(0)

          os.makedirs("renders", exist_ok=True)
          upload_flag = os.getenv("GDRIVE_UPLOAD", "true").lower() == "true"
          
          print(f"Toplam {len(json_files)} fayl SIRALI şəkildə emal olunacaq...")

          for json_file in sorted(json_files):
              output_name = f"renders/{Path(json_file).stem}.mp4"
              print(f"\n--- GÖNDƏRİLİR: {json_file} ---")
              try:
                  with open(json_file, "r") as j:
                      data = json.load(j)
                  
                  # Modal funksiyası cavabı mütləq gözləyir (Sequential)
                  video_bytes = f.remote(data, upload_gdrive=upload_flag)
                  
                  with open(output_name, "wb") as out:
                      out.write(video_bytes)
                  print(f"--- TAMAMLANDI: {output_name} ---")
              except Exception as e:
                  print(f"!!! XƏTA ({json_file}): {e}")
                  continue
          '

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-videos-${{ github.run_id }}
          path: renders/*.mp4
          if-no-files-found: warn
